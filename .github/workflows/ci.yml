name: CI - Tests y Coverage

on:
  push:
    branches: [develop, main, cd]
  pull_request:
    branches: [develop, main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      compras-changes: ${{ steps.filter.outputs.compras-changes }}
      ventas-changes: ${{ steps.filter.outputs.ventas-changes }}
      clientes-changes: ${{ steps.filter.outputs.clientes-changes }}
      bodegas-changes: ${{ steps.filter.outputs.bodegas-changes }}

    steps:
      - name: ⬇️ Checkout código
        uses: actions/checkout@v3

      - name: 📂 Detectar cambios por carpeta
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            compras-changes:
              - 'compras/**'
            ventas-changes:
              - 'ventas/**'
            clientes-changes:
              - 'clientes/**'
            bodegas-changes:
              - 'bodegas/**'

  compras-tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.compras-changes == 'true' }}

    steps:
      - name: ⬇️ Checkout código
        uses: actions/checkout@v3

      - name: 🐍 Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 🛠️ Instalar dependencias - Compras
        run: |
          pip install --upgrade pip
          pip install -r compras/requirements.txt
          pip install pytest-cov

      - name: ✅ Ejecutar tests con cobertura - Compras
        working-directory: compras
        run: |
          pytest --cov=src --cov-fail-under=70 tests/

      - name: 📊 Reportar cobertura - Compras
        working-directory: compras
        env:
          PYTHONPATH: .
        run: |
          coverage report

  ventas-tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ventas-changes == 'true' }}

    steps:
      - name: ⬇️ Checkout código
        uses: actions/checkout@v3

      - name: 🐍 Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 🛠️ Instalar dependencias - Ventas
        run: |
          pip install --upgrade pip
          pip install -r ventas/requirements.txt
          pip install pytest-cov

      - name: ✅ Ejecutar tests con cobertura - Ventas
        working-directory: ventas
        env:
          PYTHONPATH: .
        run: |
          pytest --cov=src --cov-fail-under=70 tests/

      - name: 📊 Reportar cobertura - Ventas
        working-directory: ventas
        run: |
          coverage report

  clientes-tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.clientes-changes == 'true' }}

    steps:
      - name: ⬇️ Checkout código
        uses: actions/checkout@v3

      - name: 🐍 Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 🛠️ Instalar dependencias - Clientes
        run: |
          pip install --upgrade pip
          pip install -r clientes/requirements.txt
          pip install pytest-cov

      - name: ✅ Ejecutar tests con cobertura - Clientes
        working-directory: clientes
        env:
          PYTHONPATH: .
        run: |
          pytest --cov=src --cov-fail-under=70 tests/

      - name: 📊 Reportar cobertura - Clientes
        working-directory: clientes
        run: |
          coverage report

  bodegas-tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.bodegas-changes == 'true' }}

    steps:
      - name: ⬇️ Checkout código
        uses: actions/checkout@v3

      - name: 🐍 Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 🛠️ Instalar dependencias - Bodegas
        run: |
          pip install --upgrade pip
          pip install -r bodegas/requirements.txt
          pip install pytest-cov

      - name: ✅ Ejecutar tests con cobertura - Bodegas
        working-directory: bodegas
        env:
          PYTHONPATH: .
        run: |
          pytest --cov=src --cov-fail-under=70 tests/

      - name: 📊 Reportar cobertura - Bodegas
        working-directory: bodegas
        run: |
          coverage report
